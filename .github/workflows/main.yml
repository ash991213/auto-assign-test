name: test

on:
  push:
    branches-ignore:
      - main
  pull_request_target:

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  create-pull-request:
    if: ${{ github.event_name == 'push' }}
    name: Create Pull Request and Add Reviewers
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Create pull request
        uses: thomaseizinger/create-pull-request@master
        with:
          github_token: ${{ secrets.CREATE_PULL_REQUEST_TOKEN }}
          head: ${{ github.ref }}
          base: main
          title: 'An automatically created pull request'
          body: |
            ## ðŸš€ ìžë™ ìƒì„±ëœ í’€ ë¦¬í€˜ìŠ¤íŠ¸

            ì´ í’€ ë¦¬í€˜ìŠ¤íŠ¸ëŠ” CI íŒŒì´í”„ë¼ì¸ì— ì˜í•´ ìžë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.

            ### âœ… ê²€í†  ë° ìŠ¹ì¸ ìš”ì²­
            - **ë¦¬ë·°ì–´:** í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤! ðŸ™
            - ë³‘í•©í•˜ë ¤ë©´ ìµœì†Œ **1ëª…ì˜ ìŠ¹ì¸**ì´ í•„ìš”í•©ë‹ˆë‹¤.

            ### ðŸ” ë³€ê²½ ì‚¬í•­ ê°œìš”
            - [ ] ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ í†µê³¼í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.
            - [ ] ì½”ë“œ ë³€ê²½ ì‚¬í•­ì„ ì² ì €ížˆ ê²€í† í•˜ì„¸ìš”.
            - [ ] í•„ìš”ì— ë”°ë¼ í”¼ë“œë°±ì„ ì œê³µí•˜ì„¸ìš”.

            ### ðŸ“¢ ì•Œë¦¼
            - í’€ ë¦¬í€˜ìŠ¤íŠ¸ ë‹´ë‹¹ìžì—ê²Œ ìŠ¬ëž™ ë©”ì‹œì§€ê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. ðŸ“¬

  set-reviewers:
    name: Set reviewers
    runs-on: ubuntu-latest
    timeout-minutes: 1
    steps:
      - name: Set reviewers
        uses: actions/github-script@v5
        with:
          github-token: ${{secrets.CREATE_PULL_REQUEST_TOKEN}}
          script: |
            const reviewers = ["USER_1", "USER_2", "USER_3"];
            const actor = context.payload.pull_request.user.login;
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request.number;

            const { data: assignedReviewers } = await github.rest.pulls.listRequestedReviewers({
              owner,
              repo,
              pull_number: prNumber,
            });

            if (assignedReviewers.length === 0) {
              const filteredReviewers = reviewers.filter(reviewer => reviewer !== actor);
              const selectedReviewers = filteredReviewers.sort(() => Math.random() - 0.5).slice(0, 2);

              const prNumber = context.payload.pull_request.number;
              await github.rest.pulls.requestReviewers({
                owner,
                repo,
                pull_number: prNumber,
                reviewers: selectedReviewers
              });
            }
